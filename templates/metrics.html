<div ng-controller="MetricsCtrl as ctrl">
    <div class="row">
        <div class="col-md-12">
            <h1 class="page-header">
                Metrics Data Platform
                <small>La plateforme managée pour vos métriques et séries temporelles</small>
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-3" sidenav>
            <!-- sidenav is generated by the 'sidenav' directive -->
        </div>

        <!-- content is generated from the `metrics.md` file -->
        <div class="col-sm-8 metrics">



<h2 id="les-s-ries-temporelles">Les séries temporelles</h2>
<h3 id="qu-est-ce-qu-une-s-rie-temporelle-">Qu&#39;est ce qu&#39;une série temporelle ?</h3>
<p>Nous appelons une <strong>série temporelle</strong>, une <em>suite de mesures (périodique ou non) qui évolue au fil du temps</em>. Ces mesures sont nommées <strong>métriques</strong>.</p>
<p>Prenons l&#39;exemple de l&#39;évolution de la température dans une pièce. Elle peut se traduire sont la forme d&#39;un tableau comme celui ci-dessous :</p>
<p><img src="../images/tsaas/tsaas-table.png" alt="Evolution de la température dans une pièce (tableau)"></p>
<p>Cependant, il est plus intéressant de le visualiser sous forme d&#39;un graphique. Les températures ont été transformées en point de couleur pour simplifier la lecture.</p>
<p><img src="../images/tsaas/tsaas-graph.png" alt="Evolution de la température dans une pièce (graphique)"></p>
<p>Le graphique ci-dessus représente une <strong>série temporelle</strong> avec :</p>
<ul>
<li>en abscisse, le temps ;</li>
<li>en ordonnées, la température.</li>
</ul>
<h3 id="ou-pouvons-nous-trouver-des-s-ries-temporelles-">Ou pouvons-nous les trouver ?</h3>
<p>Les séries temporelles sont toutes autour de nous, en voici quelques exemples :</p>
<ul>
<li>Le nombre d&#39;appels à un serveur web.</li>
<li>La consommation de carburant de votre voiture.</li>
<li>La charge d&#39;un serveur.</li>
<li>Le temps qu&#39;un client prend pour s&#39;inscrire sur votre site.</li>
<li>Le temps qu&#39;un client passe sur votre site.</li>
<li>La fréquence cardiaque d&#39;une personne mesurée par sa montre connectée.</li>
</ul>
<h2 id="metrics-data-platform">Metrics Data Platform</h2>
<p><strong>Metrics Data Platform</strong> est une plateforme dédiée au stockage et au traitement de séries temporelles. L&#39;un des cas d&#39;utilisation à OVH est la supervision de serveurs. La supervision passe par :</p>
<ul>
<li>la <strong>création</strong> de métriques ;</li>
<li>la <strong>collecte</strong> de métriques ;</li>
<li>l&#39;<strong>envoi</strong> de métriques sur la plateforme ;</li>
<li>l&#39;<strong>affichage</strong> de séries temporelles ;</li>
<li>le <strong>traitement</strong> de séries temporelles.</li>
</ul>
<p>Nous allons partir de ce cas d&#39;utilisation comme exemple.</p>
<p>Dans la suite du workshop, vous serez amenez à utiliser des identifiants.</p>
<table>
<thead>
<tr>
<th>Identifiants</th>
<th>Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nic</td>
<td><input type="text" class="form-control" ng-model="ctrl.ovhNic" readonly/></td>
</tr>
<tr>
<td>Mot de passe</td>
<td><input type="text" class="form-control"  ng-model="ctrl.ovhPassword" readonly/></td>
</tr>
<tr>
<td>Token de lecture</td>
<td><input type="text" class="form-control"  ng-model="ctrl.metricsRead" readonly/></td>
</tr>
</tbody>
</table>
<h3 id="cr-ation-des-m-triques">Création des métriques</h3>
<p>Afin de créer les métriques associées à notre serveur, nous allons utiliser <a href="https://github.com/ovh/noderig">Noderig</a>.</p>
<p>Noderig est un logiciel Open-Source qui collecte les métriques du système d&#39;exploitation et les expose au format <a href="http://www.warp10.io/getting-started/#data-format">Warp10</a>. Les données collectées sont exposées localement sur <code>http://127.0.0.1:9100/metrics</code> avec le verbe HTTP <code>GET</code>.</p>
<p>Voici un exemple de métriques exposées par Noderig au format Warp10 :</p>
<pre><code>1507792638180002// os.cpu{} 9.803921569019082
1507792638180333// os.mem{} 12.593965071448396
1507792638180333// os.swap{} 0
1507792638180374// os.load1{} 0.02
1507792638180479// os.net.bytes{direction=in} 6294302043
1507792638180479// os.net.bytes{direction=out} 74125282552
1507792638189821// os.disk.fs{disk=/dev/sda1} 12.052782960199004
</code></pre><p>Si vous souhaitez avoir plus de métriques exposées par Noderig, un fichier de configuration permet de régler le niveau de métriques remontées.
La documentation est disponible sur le projet <a href="https://github.com/ovh/noderig">GitHub</a> de Noderig. Vous pouvez également implémenter votre propre collecteur de métriques et l&#39;interfacer avec Noderig.</p>
<p>Voici le fichier de configuration par défaut de Noderig :</p>
<pre><code>cpu: 1                   # CPU collector level     (Optional, default: 1)
mem: 1                   # Memory collector level  (Optional, default: 1)
load: 1                  # Load collector level    (Optional, default: 1)
disk: 1                  # Disk collector level    (Optional, default: 1)
net: 1                   # Network collector level (Optional, default: 1)

period: 1000             # Duration within all the sources should be scraped in ms (Optional)
listen: none             # Listen address, set to none to disable http endpoint    (Optional)
collectors: /opt/noderig # Custom collectors directory                             (Optional)
</code></pre><p>Nous utilisons la configuration par défaut.</p>
<p>Vous pouvez consulter les métriques renvoyées par Noderig. Pour cela, connectez-vous sur l&#39;instance VPS qui vous est allouée.</p>
<pre><code>lab1@pc11:~$ ssh {{ ctrl.sshUri }}
</code></pre><p>Une fois connecté, pour consulter les métriques exposées par Noderig, il suffit de faire une simple requête HTTP.</p>
<pre><code>debian@{{demo.vpsId}}:~$ curl http://127.0.0.1:9100/metrics
</code></pre><p>Vous devez avoir une réponse qui ressemble à l&#39;exemple de métriques ci-dessus renvoyées par Noderig.</p>
<h3 id="collecte-des-m-triques">Collecte des métriques</h3>
<p>Maintenant que Noderig expose les métriques de notre machine. Il faut venir les collecter. Chez OVH, nous utilisons un logiciel du nom de <code>Beamium</code>, il est également&nbsp;Open-Source et disponible sur <a href="https://github.com/ovh/beamium">GitHub</a>.</p>
<p>Beamium possède plusieurs rôles :</p>
<ul>
<li>la <strong>récupération</strong> de métriques auprès de logiciels de collectes comme Noderig ;</li>
<li>l&#39;<strong>envoi</strong> de métriques sur la plateforme.</li>
</ul>
<p>Nous allons nous intéresser à la récupération des métriques.</p>
<p>Beamium possède un fichier de configuration qui permet de définir les URLs qui exposent des métriques. Le format de configuration par défaut est le suivant :</p>
<pre><code>scrapers:                              # Scrapers definitions         (Optional)
    scraper1:                            # Source name                  (Required)
    url: http://127.0.0.1:9100/metrics # Prometheus endpoint          (Required)
    period: 10000                      # Polling interval(ms)         (Required)
    format: prometheus                 # Polling format               (Optional)
    metrics:                           # Filter fetched metrics       (Optional)
        - node.*                         # Regex used to select metrics (Required)
</code></pre>
          <p>Beamium a été configuré sur le VPS pour collecter et transmettre les métriques exposées par Noderig toutes les trois secondes : <code>/etc/beamium/config.yaml</code></p>
          <pre><code>scrapers:
  noderig:
    url: http://127.0.0.1:9100/metrics
    period: 3000
    format: sensision

sinks:
  source1:
    url: https://warp10.gra1.metrics.ovh.net/api/v0/update
    token: {{ctrl.metricsWrite}}

labels:
  host: {{ctrl.vpsId}}

parameters:
  source-dir: /opt/beamium/sources
  sink-dir: /opt/beamium/sinks
  log-file: /var/log/beamium/beamium.log
  scan-period: 2000
</code></pre>

<h3 id="envoi-des-m-triques-sur-la-plateforme">Envoi des métriques sur la plateforme</h3>
<p>Il est temps de nous intéresser à l&#39;envoi de ces métriques sur <strong>Metrics Data Platform</strong>. Nous avons vu précédement que Beamium vient récupérer les métriques de Noderig.</p>
<p>La plateforme est multi-protocoles, c&#39;est-à-dire que vous pouvez utiliser différents protocoles pour envoyer et interroger vos métriques. Beamium est un exemple, mais vous pouvez utiliser des agents comme <strong>scollector</strong> ou <strong>collectd</strong>.  La différenciation de ces protocoles est réalisée par l&#39;URL d&#39;envoi de métriques :</p>
<pre><code>https://[metrics:[token]@][protocol].gra1.metrics.ovh.net
</code></pre><p>avec</p>
<ul>
<li><code>token</code> : qui correspond au token d&#39;écriture qui vous est attribué lors de la création de votre projet ;</li>
<li><code>protocol</code> : qui peut être ;<ul>
<li>warp10 ;</li>
<li>opentsdb ;</li>
<li>prometheus.</li>
</ul>
</li>
</ul>
<p>Une authentification est nécessaire pour envoyer des métriques sur la plateforme. Afin de s&#39;interfacer le plus facilement possible, une <code>authentification basique</code> a été mise en place pour les protocoles <code>opentsdb</code> et <code>prometheus</code> avec comme utilisateur <code>metrics</code> et mot de passe votre <code>token d&#39;écriture</code>. En ce qui concerne le protocole <code>warp10</code>, une en-tête HTTP doit être mis en place sur la requête du nom de <code>X-Warp10-Token</code> avec comme valeur votre <code>token d&#39;écriture</code>.</p>

<h3 id="affichage-des-s-ries-temporelles">Affichage des séries temporelles</h3>
<p>Nous allons pouvoir visualiser les séries temporelles liées à votre instance VPS. Il existe plusieurs interfaces permettant de visualiser vos séries temporelles :</p>
<ul>
<li><a href="https://grafana.com">Graphana</a> ;</li>
<li><a href="https://myboard.ovh">MyBoard</a>.</li>
</ul>
<p>Ces interfaces sont disponibles pour les clients OVH en tant que SaaS (Software as a Service).</p>
<h4 id="grafana">Grafana</h4>
<p>Grafana est disponible pour les clients OVH <a href="https://grafana.tsaas.ovh.com/">à cette adresse</a>.</p>
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>Identifiant</th>
<th>Mot de passe</th>
</tr>
</thead>
<tbody>
<tr>
<td>{{ctrl.ovhNic}}</td>
<td>{{ctrl.ovhPassword}}</td>
</tr>
</tbody>
</table>
<p>Grafana étant multi-tenant, il permet le partage de contenus entre collaborateurs. Vous allez devoir créer votre organisation pour y sauvegarder vos sources de données et tableaux de bords.</p>
<p>Pour en créer une, cliquez sur l&#39;icone en haut à gauche puis sur <strong>Demo Summit</strong> et enfin <strong>+ New organization</strong>.</p>
<p><img src="../images/tsaas/tsaas-organisation.png" alt="Création d&#39;une organisation"></p>
<p>Choisissez un nom d&#39;organisation, sauvegardez, laissez les valeurs par défaut, puis cliquez à nouveau sur l&#39;icone en haut à gauche, onglet <strong>Data Sources</strong>.</p>
<p><img src="../images/tsaas/tsaas-preference.png" alt="Position du bouton Data Source"></p>
<p>Ajoutez une source de données vers <strong>Metrics Data Platform</strong>.</p>
<p><img src="../images/tsaas/tsaas-datasource.png" alt="Ajout d&#39;une data source"></p>
<p>Remplissez les champs avec les valeurs suivantes, ignorez les autres :</p>
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>Champs</th>
<th>Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>Metrics Data Platform</td>
</tr>
<tr>
<td>Type</td>
<td>Warp10</td>
</tr>
<tr>
<td>URL</td>
<td>{{ ctrl.warp10 }}</td>
</tr>
<tr>
<td>Access</td>
<td>Direct</td>
</tr>
</tbody>
</table>
<p>Vous pouvez cliquer sur <code>Save &amp; Test</code>.</p>
<p>Maintenant, nous allons créer un tableau de bord (dashboard), c&#39;est lui qui contiendra nos graphiques de séries temporelles.</p>
<p>Pour créer un nouveau tableau de bord, Dans le menu <strong>Dashboard</strong>, cliquez sur le bouton <strong>+ New</strong>.</p>
<p><img src="../images/tsaas/tsaas-new-dashboard.png" alt="Création d&#39;un tableau de bord"></p>
<p>Ensuite, cliquez sur le bouton <strong>Graph</strong>.</p>
<p><img src="../images/tsaas/tsaas-add-graph.png" alt="Ajout d&#39;un graphique"></p>
<p>Maintenant que nous avons un graphique, nous allons pouvoir l&#39;éditer afin d&#39;afficher les données de notre instance VPS. Pour éditer un graphique, cliquez sur le titre de celui-ci (ici <em>PanelTitle</em>) puis sur <strong>Edit</strong>.</p>
<p><img src="../images/tsaas/tsaas-edit-graph.png" alt="Edition d&#39;un graphique"></p>
<p>Nous allons éditer notre graphique afin d&#39;afficher le pourcentage d&#39;utilisation des CPUs.
Supprimez les <strong>Test metrics</strong>, puis dans la partie <strong>Metrics</strong>, il faut changer la <strong>data source</strong> de <em>default</em> à <em>Metrics Data Platform</em>.</p>
<p><img src="../images/tsaas/tsaas-edit-graph-metrics.png" alt="Changement de la source de données"></p>
<p>Nous obtenons alors ceci :</p>
<p><img src="../images/tsaas/tsaas-edit-graph-editor.png" alt="Editeur WarpScript"></p>
<p>C&#39;est l&#39;éditeur de requête WarpScript pour interroger la plateforme. Dedans, nous allons pouvoir y insérer notre requête :</p>
<pre><code>// Stockage du token de lecture dans la variable readToken.
&#39;{{ctrl.metricsRead}}&#39; &#39;readToken&#39; STORE

// Définition du nombre de points retournés
50 &#39;buckets&#39; STORE

// Calcul de la taille d&#39;un bucket en tenant compte de la fenêtre de visualistation et du nombre de points souhaités
$interval $buckets / &#39;bucket&#39; STORE

// Récupération des métriques
[ $readToken &#39;os.cpu&#39; { } $end $interval ] FETCH

// Ré-échantillonnage de la série temporelle
[ SWAP bucketizer.max $end $bucket $buckets ] BUCKETIZE
</code></pre><p>On obtient un graphique qui représente le pourcentage d&#39;utilisation des CPUs du VPS.</p>
<p>Pour en savoir plus sur ce langage de programmation, WarpScrit fournit <a href="http://www.warp10.io/apis/warpscript/" target="_blank">une excellente documentation en ligne</a>.</p>
<p><img src="../images/tsaas/tsaas-edit-graph-display.png" alt="Graphique d&#39;utilisation du pourcentage maximum des CPUs du VPS"></p>
<p>Vous pouvez sauvegarder et revenir en arrière pour afficher le tableau de bord en appuyant sur le bouton <strong>back to dashboard</strong>.</p>
<div class="alert alert-info">

<p>Grafana vous permet d'importer facilement des nouveaux tableaux de board</p>
<p>Vous pouvez tester un tableau de bord préconfiguré en important le fichier json disponible <a href="/grafana-noderig.json">ici</a>.</p>
</div>

<br/><br/><br/><br/><br/>

        </div>
    </div>
</div>